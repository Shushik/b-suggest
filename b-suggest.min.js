/**
 * @page        http://github.com/Shushik/b-suggest/
 * @author      Shushik <silkleopard@yandex.ru>
 * @version     2.0
 * @description a simple javascript calendar
 *
 * @constructor
 *
 * @this   {Cal}
 * @param  {DOMNode}
 * @param  {DOMNode}
 * @param  {Object}
 * @param  {Object}
 * @return {Cal}
 */
;Suggest=function(){function l(a,c,b,d){d=d||{};arguments&&2<arguments.length&&this.init(a,c,b,d);return this}l.prototype={init:function(a,c,b,d){b=b||{};d=d||{};var e="";this._aborted=this.grouped=this.shown=!1;this.items=0;this._saved="";this._timer=null;this._nodes={block:null,items:{loop:0,total:0,list:[]},groups:[],field:c,target:a};b.groups&&!this._groups&&(this._groups=[].concat(b.groups),this.grouped=!0);this._events=[];this._params={};for(e in b)this._params[e]=b[e];this._handlers=d;this._install(); return this},show:function(a,c){a=a||!1;c=c||"{{name}}";var b=this._params.offset_ignore,d=this._nodes.block,e=this._offsetize(this._nodes.field,this._nodes.target);this._saved=this._nodes.field.value;if(this._aborted)return this._aborted=!1,this._nodes.block;"object"==typeof a&&this._draw(a,c);0<this._nodes.items.list.length&&(d.className+=" b-suggest_is_visible",this.shown=!0,this.hover(0,!0),!0!==b&&"all"!=b&&("top"!=b&&(d.style.top=e.top+e.height+"px"),"left"!=b&&(d.style.left=e.left+"px"),d.style.width= e.width+"px"));return this._nodes.block},prev:function(){var a=this._nodes.items,c=a.loop,b=a.total-1;0==c?c=b:c--;this.hover(c,!0);return a[c]},next:function(){var a=this._nodes.items,c=a.loop;c==a.total-1?c=0:c++;this.hover(c,!0);return a[c]},hide:function(a){this._nodes.block.className=this._nodes.block.className.replace(" b-suggest_is_visible","");this.shown=!1;this._aborted&&(this._aborted=!1);a||(this._saved="");return this},hover:function(a,c){a=0<=a?a:this._nodes.items.loop;var b=this._nodes.items.list, d=b[this._nodes.items.loop]?b[this._nodes.items.loop]:b[0],b=b[a]?b[a]:b[0];this._offsetize(b,this._nodes.block);d.className="b-suggest__item";b.className="b-suggest__item b-suggest__item_is_hovered";c&&(this.grouped?b.parentNode.parentNode.scrollTop=0==a?b.parentNode.offsetTop:b.offsetTop:b.parentNode.scrollTop=b.offsetTop);this._nodes.items.loop=a;return this._nodes.block},uninstall:function(){var a=this._events.length,c=null,b=this._nodes.block,d=this._nodes.target;for(pos=0;pos<a;pos++)c=this._events[pos], this._unbind(c.target,c.alias,c.handler);delete this.shown;delete this._timer;delete this._saved;delete this._nodes;delete this._events;delete this._params;delete this._aborted;delete this._handlers;d.removeChild(b)},_install:function(){var a=this._nodes;this._saved=a.field.value;a.field.setAttribute("autocomplete","off");a.field.className+=" b-suggest__field";a.block=document.createElement("div");a.block.className="b-suggest";a.target.appendChild(a.block);this._params.id&&(a.block.className+=" b-suggest_id_"+ this._params.id);this._events.push(this._bind(document,"click",this._proxy(this._click4document,this)));this._events.push(this._bind(document,"touchstart",this._proxy(this._click4document,this)));this._events.push(this._bind(a.field,"blur",this._proxy(this._blur4field,this)));this._events.push(this._bind(a.field,"focus",this._proxy(this._focus4field,this)));this._events.push(this._bind(a.field,"keydown",this._proxy(this._keydown4field,this)));this._events.push(this._bind(a.field,"keyup",this._proxy(this._keyup4field, this)));this._events.push(this._bind(this._nodes.block,"mouseover",this._proxy(this._mouseover4block,this)));this._events.push(this._bind(this._nodes.block,"mouseout",this._proxy(this._mouseout4block,this)));this._events.push(this._bind(this._nodes.block,"click",this._proxy(this._click4block,this)));this._events.push(this._bind(this._nodes.block,"touchstart",this._proxy(this._click4block,this)))},_draw:function(a,c){var b=a instanceof Array,d="simple",e=this._nodes;this.grouped=!1;e.groups=[];this._nodes.items.total= 0;e.items.loop=0;e.items.list=[];e.block.innerHTML="";"object"==typeof a?b||(d="grouped",this.grouped=!0):a=[];this["_draw4"+d](a,c||"{{name}}")},_draw4simple:function(a,c){for(var b=0,d=0,e=null,f=this._nodes,d=a.length,b=0;b<d;b++)e=this._item2node(a[b],this._tmpl(c,a[b])),f.block.appendChild(e)},_draw4grouped:function(a,c){for(var b=0,d=0,e=this._groups?this._groups:[],f=null,f=null,j=this._nodes,d=this._groups.length,b=0;b<d;b++)f=e[b],a[f.alias]&&a[f.alias].length&&(f=this._group2node(f.alias, f.name?f.name:"",f.tmpl?f.tmpl:c,a[f.alias]),j.block.appendChild(f))},_group2node:function(a,c,b,d){var e=0,f=d.length,j=null,g=document.createElement("div"),e=null;g.className="b-suggest__group b-suggest__group_id_"+a;c&&(e=document.createElement("div"),e.className="b-suggest__title",e.innerHTML=c,g.appendChild(e));for(e=0;e<f;e++)j=this._item2node(d[e],this._tmpl(b,d[e])),g.appendChild(j);this._nodes.groups.push(g);return g},_item2node:function(a,c){var b=this._nodes.items.total,d="",e=[],f=this._nodes.items.list[b]= document.createElement("div");f.className=0==b?"b-suggest__item b-suggest__item_is_hovered":"b-suggest__item";f.innerHTML=c;for(d in a)e.push(d),f.setAttribute("data-"+d,a[d]);f.setAttribute("data-loop",b);f.setAttribute("data-keys",e.join(","));this._nodes.items.total++;return f},_click4document:function(a){var c=!1;a.target.className.match(/b\-suggest/ig)&&(c=!0);this.shown&&!c&&this.hide()},_focus4field:function(){""!=this._nodes.field.value&&this.show(!0);this._aborted=!1},_blur4field:function(){this.hide()}, _keydown4field:function(a){13==a.keyCode&&(a.preventDefault(),this.shown&&this._nodes.items.list[this._nodes.items.loop]&&this._nodes.items.list[this._nodes.items.loop].click())},_keyup4field:function(a){var c=this._nodes.field.value,b=this;switch(a.keyCode){case 9:case 13:case 16:case 17:case 18:case 20:case 37:case 39:case 224:return!0;case 27:this.shown&&this.hide();break;case 38:this.shown&&this.prev();break;case 40:this.shown?this.next():""!=c&&this.show();break;default:this._timer&&clearTimeout(this._timer), this.hide(!0),""!=c&&c!=this._saved?this._timer=setTimeout(function(){b._handlers.load.call(b._nodes.field,a,{done:b._proxy(b.show,b),hide:b._proxy(b.hide,b)})},300):""==c&&(this._aborted=!0)}},_mouseover4block:function(a){this.hover(a.target.getAttribute("data-loop"))},_mouseout4block:function(){this.hover(0)},_click4block:function(a){a.target.className.match("b-suggest__item")&&(this._timer&&clearTimeout(this._timer),this._handlers.click.call(this._nodes.items.list[this._nodes.items.loop],a,{done:this._proxy(this.hover, this),hide:this._proxy(this.hide,this)}))},_tmpl:function(a,c){c=c||{};a=a.replace(/\{\{ ?/g,"';out+=").replace(/ ?\}\}/g,";out+='").replace(/\{% if ?([^%]*) ?%\}/ig,"';if($1){out+='").replace(/\{% else ?%\}/ig,"';}else{out+='").replace(/\{% ?endif ?%\}/ig,"';}out+='");var b="",d="";for(d in c)b+=d+'=data["'+d+'"],';return eval(";(function(){var "+b+"out = '"+a+"';return out;})();")},_bind:function(a,c,b){var d="",e="",f=this,j={alias:c,target:a,handler:function(a){a=f._eventize(a);b(a)}};a.addEventListener? e="addEventListener":a.attachEvent&&(d="on",e="attachEvent");a[e](d+c,j.handler);return j},_unbind:function(a,c,b){var d="",e="";a.removeEventListener?e="removeEventListener":a.detachEvent&&(d="on",e="detachEvent");a[e](d+c,b)},_offsetize:function(a,c){c=c||document.body;var b=!1,d=/^t(?:able|d|h)$/i,e=document,f=e.body,j=e.defaultView?e.defaultView.getComputedStyle:null,g=a,m=j?j(g,null):g.currentStyle,k=null,h={top:g.offsetTop,left:g.offsetLeft,width:g.offsetWidth,height:g.offsetHeight},l=g.offsetParent; for(navigator.userAgent.match(/MSIE [67]/)&&"CSS1Compat"!=e.compatMode&&(b=!0);(g=g.parentNode)&&g!=c&&"fixed"!==m.position;)k=j?j(g,null):g.currentStyle,h.top-=g.scrollTop,h.left-=g.scrollLeft,g===l&&(h.top+=g.offsetTop,h.left+=g.offsetLeft,b&&d.test(g.tagName)&&(h.top+=parseFloat(k.borderTopWidth)||0,h.left+=parseFloat(k.borderLeftWidth)||0),l=g.offsetParent),"visible"!==k.overflow&&(h.top+=parseFloat(k.borderTopWidth)||0,h.left+=parseFloat(k.borderLeftWidth)||0),m=k;g===f&&("relative"===m.position|| "static"===m.position?(h.top+=f.offsetTop,h.left+=f.offsetLeft):"fixed"===m.position&&(h.top+=Math.max(e.scrollTop,f.scrollTop),h.left+=Math.max(e.scrollLeft,f.scrollLeft)));return h},_eventize:function(a){a=a||window.event;var c=navigator.userAgent.match(/opera/ig)?!0:!1,b=a.type;!c&&a.srcElement&&(a.target=a.srcElement);!c&&3==a.target.nodeType&&(a.target=a.target.parentNode);if(("keypress"==b||"keydown"==b||"keyup"==b)&&!a.keyCode&&a.which)a.keyCode=a.which;c||(a.relatedTarget||(a.relatedTarget= a.fromElement),a.stopPropagation||(a.stopPropagation=function(){this.cancelBubble=!0}),a.preventDefault||(a.preventDefault=function(){this.returnValue=!1}));return a},_proxy:function(a,c){return function(){return a.apply(c,arguments)}}};return l}();